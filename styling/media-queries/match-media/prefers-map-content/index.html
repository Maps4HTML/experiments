<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Minimum Snow and Ice</title>
  <script type="module" src="../../../../dist/mapml.js"></script>
  <link rel="stylesheet" href="../../../../global.css">
  <style>
    body {
      display: flex;
      flex-direction: row;
    }

    mapml-viewer {
      flex: 3;
    }

    .content-button.selected {
      background-color: #007bff;
      color: white;
      border: 1px solid #007bff;
    }

    .content-button {
      margin: 5px;
      padding: 10px 20px;
      cursor: pointer;
    }

    .description {
      flex: 1;
    }
  </style>
</head>

<body>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Ensure M.options.contentPreference is initialized
      if (!M.options.contentPreference) {
        M.options.contentPreference = [];
      }

      // Get references to the elements
      const buttons = document.querySelectorAll('.content-button');
      const selectedPreferencesDisplay = document.getElementById('selectedPreferences');
      const layers = document.querySelectorAll('map-layer');
      const map = document.querySelector('mapml-viewer');

      // Function to update the selected preferences display
      function updatePreferencesDisplay() {
        const preferences = M.options.contentPreference || [];
        selectedPreferencesDisplay.textContent = preferences.length
          ? preferences.join(', ')
          : 'None';
      }

      // Function to check layer visibility
      function checkLayerVisibility() {
        layers.forEach((layer) => {
          const mediaQuery = layer.getAttribute('media');
          if (!mediaQuery) return; // Skip layers without a media attribute

          // Use matchMedia to evaluate the media query
          const matches = map.matchMedia(mediaQuery).matches;

          if (matches) {
            // Show the layer if it matches
            layer.removeAttribute('hidden');
            layer.removeAttribute('disabled');
            console.log(`showing layer with ${mediaQuery}`)
          } else {
            // Hide and disable the layer if it doesn't match
            layer.setAttribute('hidden', '');
            layer.setAttribute('disabled', '');
            console.log(`not showing layer with ${mediaQuery}`)
          }
        });
      }

      // Add click event listeners to each button
      buttons.forEach((button) => {
        button.addEventListener('click', () => {
          console.log('button clicked');
          const contentType = button.getAttribute('data-type');

          // Check if the type is already selected
          let index = M.options.contentPreference.indexOf(contentType);

          if (index === -1) {
            // Add the type if not already selected
            M.options.contentPreference.push(contentType);
            button.classList.add('selected'); // Optional: Add visual indication
          } else {
            while (index !== -1) {
              // Remove the type if already selected
              M.options.contentPreference.splice(index, 1);
              button.classList.remove('selected'); // Optional: Remove visual indication
              index = M.options.contentPreference.indexOf(contentType);
            }
          }

          // Update the display and check layer visibility
          updatePreferencesDisplay();
          checkLayerVisibility();
        });
      });

      // Initialize the display
      updatePreferencesDisplay();
      checkLayerVisibility();
    });
  </script>

  <mapml-viewer projection="CBMTILE" zoom="4" lat="60" lon="-90" controls>
    <map-layer label="Minimum Snow and Ice" src="msi.mapml" media="(prefers-map-content: images)" checked></map-layer>
    <map-layer label="Permanent snow and ice (prob. 94% or more) WMS GetMap" src="msi-94-plus.mapml"
      media="(prefers-map-content: images)" checked></map-layer>
    <map-layer label="Provinces and territories of Canada" src="features.mapml" media="(prefers-map-content: features)"
      checked></map-layer>
    <map-layer label="Probability of the annual minimum snow and ice presence - Tiled WMS GetMap"
      media="(prefers-map-content: tiles) and (prefers-map-content: images)" src="msi-tiles.mapml" checked></map-layer>
    <map-layer label="Permanent snow and ice (prob. 94% or more) WMS GetMap - Tiled WMS GetMap"
      media="(prefers-map-content: tiles) and (prefers-map-content: images)" src="msi-94-plus-tiles.mapml"
      checked></map-layer>
  </mapml-viewer>

  <div class="description">
    <h3>Content Preferences</h3>
    <div>
      <button class="content-button" data-type="images">Images</button>
      <button class="content-button" data-type="tiles">Tiles</button>
      <button class="content-button" data-type="features">Features</button>
      <button class="content-button" data-type="tables">Tables</button>
    </div>
    <p>Selected Preferences: <span id="selectedPreferences">None</span></p>
  </div>

</body>

</html>